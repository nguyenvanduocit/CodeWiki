# Web Frontend Module

## Overview

The Web Frontend module provides a web interface for users to submit GitHub repositories for documentation generation. It includes a FastAPI-based web application with background processing, caching, and documentation visualization capabilities.

## Components

### Core Files

| File | Purpose | Lines |
|------|---------|-------|
| `web_app.py` | FastAPI application entry point and route registration | 133 |
| `routes.py` | HTTP route handlers for web interface and API | 299 |
| `github_processor.py` | GitHub URL validation and repository cloning | 93 |
| `background_worker.py` | Async job processing queue | 256 |
| `cache_manager.py` | Documentation result caching | 118 |
| `visualise_docs.py` | Standalone documentation server | 268 |
| `models.py` | Pydantic and dataclass models | 55 |
| `config.py` | Web application configuration | 51 |
| `templates.py` | HTML templates (web interface and docs viewer) | 680 |
| `template_utils.py` | Jinja2 template rendering utilities | 113 |

### Data Models

**JobStatus** (`models.py:33`)
- Tracks documentation generation job state
- States: `queued`, `processing`, `completed`, `failed`
- Stores timing, progress messages, error details

**CacheEntry** (`models.py:49`)
- Represents cached documentation result
- URL-based lookup with SHA256 hash
- Tracks creation and last access times

**JobStatusResponse** (`models.py:17`)
- Pydantic model for API responses
- Includes all job fields for JSON serialization

## API Routes

| Route | Method | Purpose |
|-------|--------|---------|
| `/` | GET | Main submission form with recent jobs list |
| `/` | POST | Submit repository URL for processing |
| `/api/job/{job_id}` | GET | Get job status as JSON |
| `/docs/{job_id}` | GET | Redirect to documentation viewer |
| `/static-docs/{job_id}/{filename}` | GET | Serve generated documentation files |

## GitHub Integration Flow

1. **URL Validation** (`github_processor.py:18`)
   - Validates GitHub URL format
   - Extracts owner/repo from path
   - Supports `github.com` and `www.github.com`

2. **Repository Cloning** (`github_processor.py:54`)
   - Shallow clone (`--depth 1`) for default branch
   - Full clone when specific commit requested
   - Configurable timeout (300s default)

3. **Job Deduplication** (`routes.py:74`)
   - Normalizes URL to `owner/repo` format
   - Prevents duplicate queued/processing jobs
   - 3-minute cooldown for failed jobs

## Background Processing

**Queue System** (`background_worker.py:26`)
- Thread-based worker with `Queue(maxsize=100)`
- Job persistence to `jobs.json` in cache directory
- Automatic cleanup of old completed/failed jobs

**Processing Pipeline** (`background_worker.py:163`)
1. Check cache for existing documentation
2. Clone repository to temp directory
3. Run `DocumentationGenerator` via async event loop
4. Cache results and update job status
5. Cleanup temp directory

**Job Recovery** (`background_worker.py:91`)
- Reconstructs jobs from cache index on startup
- Maintains state across server restarts

## Caching Strategy

**Cache Key Generation** (`cache_manager.py:61`)
- SHA256 hash of normalized repo URL (first 16 chars)
- Stored in `cache_index.json`

**Cache Expiration** (`cache_manager.py:65`)
- Default: 365 days (`CACHE_EXPIRY_DAYS`)
- Automatic cleanup on access
- Last-accessed tracking for LRU behavior

**Cache Location** (`config.py:14`)
- Default: `./output/cache/`
- Job statuses: `{cache_dir}/jobs.json`

## Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| `CACHE_DIR` | `./output/cache` | Documentation cache location |
| `TEMP_DIR` | `./output/temp` | Temporary clone directory |
| `QUEUE_SIZE` | 100 | Max concurrent queued jobs |
| `CACHE_EXPIRY_DAYS` | 365 | Cache TTL |
| `JOB_CLEANUP_HOURS` | 24000 | Job retention period |
| `RETRY_COOLDOWN_MINUTES` | 3 | Failed job retry delay |
| `CLONE_TIMEOUT` | 300 | Git clone timeout (seconds) |
| `CLONE_DEPTH` | 1 | Shallow clone depth |

## Documentation Visualization

**Standalone Server** (`visualise_docs.py`)
- Separate FastAPI app for viewing generated docs
- Renders markdown with Mermaid diagram support
- Navigation from `module_tree.json`

**Template Features** (`templates.py:323`)
- Responsive sidebar navigation
- Syntax-highlighted code blocks
- Mermaid diagram rendering
- Generation metadata display

## Usage

### Starting the Web Application

```bash
python -m codewiki.src.fe.web_app --host 127.0.0.1 --port 8000
```

### Starting the Documentation Server

```bash
python -m codewiki.src.fe.visualise_docs --docs-folder ./output/docs/repo-docs --port 8080
```

### Environment Variables

- `DOCS_FOLDER`: Path to documentation folder (for visualise_docs)

<!-- ORACLE-ENHANCED
Generated by codebase-oracle to validate and enhance CodeWiki output.
Validation timestamp: 2026-02-12
Audience: new engineer, oncall
Primary tasks: debug API issues, add endpoints, monitor jobs
-->

## Oracle Validation

### Validation Status
| Section | Status | Notes |
|---------|--------|-------|
| Components | Validated | All 10 files analyzed |
| API Routes | Validated | 5 routes confirmed |
| GitHub Integration | Validated | URL parsing and cloning verified |
| Background Processing | Validated | Queue system and job lifecycle confirmed |
| Caching Strategy | Validated | Hash-based cache with expiration |
| Documentation Viz | Validated | Mermaid support confirmed |

### Claim Ledger
| Claim | Evidence | Confidence | Impact |
|-------|----------|------------|--------|
| Web app uses FastAPI | `web_app.py:14` | ▓▓▓▓▓ | Framework choice |
| Background worker uses threading | `background_worker.py:42` | ▓▓▓▓▓ | Concurrency model |
| Cache uses SHA256 hashing | `cache_manager.py:63` | ▓▓▓▓▓ | Cache key generation |
| Job states: queued/processing/completed/failed | `models.py:37` | ▓▓▓▓▓ | State machine |
| Git clone timeout is 300s | `config.py:33` | ▓▓▓▓▓ | Timeout configuration |
| Queue max size is 100 | `config.py:19` | ▓▓▓▓▓ | Backpressure limit |
| Cache expiry is 365 days | `config.py:22` | ▓▓▓▓▓ | Retention policy |
| Job cleanup after 24000 hours | `config.py:25` | ▓▓▓▓▓ | Job retention |
| Retry cooldown is 3 minutes | `config.py:26` | ▓▓▓▓▓ | Failure handling |
| Shallow clone depth is 1 | `config.py:34` | ▓▓▓▓▓ | Clone optimization |
| Supports specific commit checkout | `github_processor.py:62` | ▓▓▓▓▓ | Version pinning |
| Job ID format: `owner--repo` | `routes.py:282` | ▓▓▓▓▓ | URL-safe identifiers |
| Mermaid diagrams supported | `visualise_docs.py:68` | ▓▓▓▓▓ | Diagram rendering |
| Job persistence to JSON | `background_worker.py:126` | ▓▓▓▓▓ | State recovery |
| Cache reconstruction on startup | `background_worker.py:91` | ▓▓▓▓▓ | Recovery mechanism |
| Form submission protection | `templates.py:277` | ▓▓▓▓▓ | UX safeguard |
| Directory traversal protection | `visualise_docs.py:154` | ▓▓▓▓▓ | Security |
| Only completed jobs loaded from disk | `background_worker.py:75` | ▓▓▓▓▓ | State consistency |

### Design Rationale and Trade-offs

**Threading vs Asyncio for Background Worker**
- **Decision**: Uses threading (`background_worker.py:42`) despite FastAPI's async nature
- **Rationale**: Documentation generation spawns subprocesses (git clone) and runs CPU-intensive analysis
- **Trade-off**: Simpler than managing async subprocesses, but limits scalability to single worker thread

**In-Memory Queue vs External Queue**
- **Decision**: Python `Queue` class with in-memory storage
- **Rationale**: Simplicity for single-server deployment
- **Trade-off**: Jobs lost on crash (mitigated by job persistence for completed jobs only)

**SHA256 Hash for Cache Keys**
- **Decision**: First 16 chars of SHA256 (`cache_manager.py:63`)
- **Rationale**: URL-safe, deterministic, collision-resistant for practical repo counts
- **Trade-off**: Fixed cache location, not human-readable

**Shallow Clone by Default**
- **Decision**: `--depth 1` unless specific commit requested (`github_processor.py:82`)
- **Rationale**: Faster clones, less disk usage for documentation generation
- **Trade-off**: Cannot checkout arbitrary commits without full reclone

**Job ID Format: `owner--repo`**
- **Decision**: Double-dash separator (`routes.py:282`)
- **Rationale**: URL-safe, reversible, human-readable
- **Trade-off**: Assumes no repo names contain double-dash

### Failure Modes and Recovery

| Failure | Impact | Detection | Recovery |
|---------|--------|-----------|----------|
| Git clone timeout | Job fails with error | Exception caught | User can retry after cooldown |
| Disk full during generation | Job fails, temp files remain | Write error | Manual cleanup of `TEMP_DIR` |
| Cache corruption | Cache miss, regeneration | JSON parse error | Cache entry ignored, regen |
| Jobs file corruption | Lost job history | JSON parse error | Reconstruct from cache |
| Worker thread crash | Queue stops processing | Jobs stuck in queued | Restart server |
| Memory exhaustion | OOM kill | System monitor | Reduce `QUEUE_SIZE` |

**Job Stuck in Processing**
- Check: `api/job/{job_id}` returns `processing` for long time
- Cause: Worker thread crashed during processing
- Recovery: Restart server, job will remain stuck (known limitation)

**Cache Not Hitting**
- Check: Same repo re-processes instead of cache hit
- Cause: URL normalization mismatch or cache expired
- Debug: Compare `repo_hash` in cache index vs calculated hash

### Blast Radius and Safe Change Plan

**Adding New API Endpoints**
- Safe zone: Add to `web_app.py` following existing patterns
- Test: Verify route registration and response format
- Risk: Low

**Modifying JobStatus Model**
- Impact: `jobs.json` compatibility, API responses
- Required: Migration logic in `load_job_statuses()`
- Risk: Medium - breaking change for persisted jobs

**Changing Cache Key Algorithm**
- Impact: All cached docs invalidated
- Required: Cache version bump or migration
- Risk: High - regeneration cost

**Modifying Git Clone Logic**
- Impact: All repository processing
- Test: Verify with private repos, large repos, specific commits
- Risk: Medium - authentication and timeout edge cases

**Template Changes**
- Impact: UI rendering only
- Test: Visual regression
- Risk: Low

### Unknowns and Verification

| Unknown | Verification Method | Priority |
|---------|---------------------|----------|
| Private repository support | Test with GitHub token auth | High |
| Maximum repository size | Load test with large repos | Medium |
| Concurrent job limit | Stress test queue behavior | Medium |
| Browser compatibility | Test Mermaid rendering | Low |
| Cache size limits | Monitor disk usage | Medium |

### Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Route handlers | ▓▓▓▓▓ | Straightforward FastAPI patterns |
| Git integration | ▓▓▓▓░ | Standard git commands, timeout handling |
| Background processing | ▓▓▓▓░ | Simple threading, but recovery could be improved |
| Caching | ▓▓▓▓▓ | Hash-based lookup is reliable |
| Templates | ▓▓▓▓▓ | Static HTML with Jinja2 |
| Configuration | ▓▓▓▓▓ | Centralized in config.py |

**Overall Confidence**: ▓▓▓▓░ (High)

The Web Frontend module is well-structured with clear separation of concerns. The main areas for improvement are:
1. Worker crash recovery (stuck jobs)
2. Private repository authentication
3. Horizontal scaling (currently single-threaded worker)
